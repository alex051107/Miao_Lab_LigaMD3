# System Instruction: HSP90 Structure Preparation Pipeline

This document serves as an instruction manual for AI agents working on the HSP90 system preparation pipeline for CHARMM-GUI. 

## 1. Core Logic for Structure Preparation

When processing new PDB or CIF files for molecular dynamics (MD) simulations in this repository, follow this strict logic:

1.  **Extract Native Coordinates (PURE CIF):** ALWAYS extract the ligand directly from the native `.cif` or `.pdb` complex in PyMOL (`cmd.extract`) to preserve the exact spatial coordinates relative to the protein pocket. **NEVER** download ideal MOL2 files from the RCSB ModelServer API, as their coordinates are at the origin (0,0,0) and their bond types/atom types can break in GAFF2.
2.  **Handle Altlocs In-Place:** If the ligand possesses multiple alternate locations (e.g., conformations A and B), keep only the preferred conformation in PyMOL (`cmd.remove("not alt ''+B")` and clear alt labels) BEFORE extracting.
3.  **Add Hydrogens Locally:** Use PyMOL (`cmd.h_add`) to protonate the extracted ligand and export as MOL2.
4.  **Sanitize PDB Complex:**
    *   **Single Chain (Multi-mer check):** Force the selection of a single asymmetric unit (e.g., Chain A and its associated ligand) if the crystal contains dimers or tetramers.
    *   **Element Case in PDB:** If the ligand contains halogens (Chlorine, Bromine), PyMOL may export them as `CL` or `BR` in the **PDB element column (cols 77-78)**. You MUST use a script to fix the PDB element column to `Cl` or `Br`. (Wait, PyMOL natively exports the correct `Cl` in MOL2, so only the PDB element column needs fixing).

## 2. Historical Errors & Troubleshooting

Before uploading to CHARMM-GUI, the agent MUST verify the processed files against these known pitfalls:

*   **Error:** `ABNORMAL TERMINATION: Undefined coordinates` (Usually in Step 1 `hbuild` or PBC Setup).
    *   **Cause A (Overlapping Altlocs):** The PDB contains overlapping alternate conformations (e.g., both alt A and alt B of the same residue) which creates duplicate coordinate entries. CHARMM-GUI gets confused. It is NOT because occupancy is < 1.00; valid < 1.00 occupancy is fine as long as the coordinate is unique.
    *   **Cause B (Coordinate Mismatch):** The `_ligand_H.mol2` coordinates are at origin `[0.0, 0.0, 0.0]` while the `_complex.pdb` ligand is in the protein pocket. This happens if the MOL2 was downloaded from RCSB rather than natively extracted from the complex using PyMOL.
*   **Error:** `ANTECHAMBER failed to parameterize force field` or `Ligand FF parameterization failed`.
    *   **Cause (Halogens):** The ligand contains halogens (Chlorine, Bromine) that are printed in uppercase (e.g., `CL`, `BR`) in either the PDB atom name column (cols 13-16), PDB element column (cols 77-78), or the MOL2 Tripos type column. Antechamber/GAFF2 strictly requires `Cl` and `Br`.
*   **Error:** Duplicate chains in CHARMM-GUI PDB Reader (e.g., `PROA, PROB` and `HETA, HETB`).
    *   **Cause:** The biological assembly or asymmetric unit contains multiple identical chains.
    *   **Fix:** Pre-process the CIF/PDB to extract and save only one chain pair.

## 3. Policy for Updating Documentation

The agent must proactively maintain system documentation:

*   **When to update `project_log.md`:**
    *   *Immediately* after encountering and resolving a new error in CHARMM-GUI, PyMOL, or Amber.
    *   When a script's behavior is fundamentally altered to fix a bug.
*   **When to update `HSP90_LiGaMD3_Complete_Workflow.md`:**
    *   When the step-by-step pipeline changes (e.g., moving from manual PyMOL clicking to batch Python scripts).
    *   When a new "Pitfall/Troubleshooting" rule is discovered that future users or agents must follow to avoid breaking the pipeline (see Section 1.7 of the workflow).
*   **When to update this file (`.ai_instruction.md`):**
    *   When the core architectural logic of the preparation pipeline changes (e.g., switching from PyMOL to a different topology generator).
*   **When to update GitHub (CRITICAL AI RESPONSIBILITY):**
    *   **DAILY** or at the end of every major task session. 
    *   The AI MUST proactively run `git add .`, `git commit -m "update logs/structures"`, and `git push` to `main` to ensure there is no local data loss and the repository stays synchronized.
    *   The user explicitly requested this as a habit. Do not wait for permission if the task involves generating new structures or updating critical workflow documents.
